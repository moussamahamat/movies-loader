def imageName = '3036/movies-loader'
def registry = 'https://hub.docker.com/repository/docker/3036/pyhtonapp/general'
def registryCredential = 'dockerhub' 

pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
      stages{
           
        stage('Unit Tests'){
            steps{
                script {
                    def imageTest= docker.build("${imageName}-test", "-f Dockerfile.test .")
                    imageTest.inside{
                        sh "python test_main.py"
                    }
                }
            }
        }
           
        stage('Build') {
            steps {
                script {
                   imageName = docker.build("${imageName}")
               }
            }
         }
          
        
        stage('Deploy our image') { 
            steps { 
                script { 
                    docker.withRegistry('', registryCredential) { 
                        imageName.push()

              }
            } 
          }
        } 
          
     stage('Run Docker container on Jenkins Agent') {
         steps {
                sh "docker run -d -p 4030:80 3036/movies-loader"
 
            }
        }


          
          
           
     }
 }
