def imageName = '3036/movies-loader'
def registry = 'https://hub.docker.com/repository/docker/3036/pyhtonapp/general'
def registryCredential = 'docker-hub' 

pipeline {
    agent none
    options {
        skipStagesAfterUnstable()
    }
      stages{
           
        stage('Unit Tests'){
            steps{
                script {
                    def imageTest= docker.build("${imageName}-test", "-f Dockerfile.test .")
                    imageTest.inside{
                        sh "python test_main.py"
                    }
                }
            }
        }
           
        stage('Build') {
            steps {
                script {
                 def image= docker.build("${imageName}")
               }
            }
         }
          
        
        stage('Deploy our image') { 
            steps { 
                script { 
                    docker.withRegistry(registryCredential, '') { 
                    docker.image(imageName).push()
              }
            } 
          }
        } 

           
     }
 }
