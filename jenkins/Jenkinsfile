def imageName = '3036/movies-loader'
def registry = 'https://hub.docker.com/repository/docker/3036/pyhtonapp/general'
def registryCredential = 'dockerhub' 

pipeline {
    agent none
    options {
        skipStagesAfterUnstable()
    }
      stages{
           
        stage('Unit Tests'){
            steps{
                script {
                    def imageTest= docker.build("${imageName}-test", "-f Dockerfile.test .")
                    imageTest.inside{
                        sh "python test_main.py"
                    }
                }
            }
        }
           
        stage('Build') {
            steps {
                script {
                   imageName = docker.build("${imageName}")
               }
            }
         }
          
        
        stage('Deploy our image') { 
            steps { 
                script { 
                    docker.withRegistry('', registryCredential) { 
                        imageName.push()

              }
            } 
          }
        } 
          
      stage("Deploy - Dev") {
            steps { deploy('dev') }
		}


          
          
           
     }
 }




def deploy(environment) {

	def containerName = ''
	def port = ''

	if ("${environment}" == 'dev') {
		containerName = "app_dev"
		port = "8888"
	} 
	else if ("${environment}" == 'stage') {
		containerName = "app_stage"
		port = "88"
	}
	else if ("${environment}" == 'live') {
		containerName = "app_live"
		port = "80"
	}
	else {
		println "Environment not valid"
		System.exit(0)
	}
	
	sh "docker ps -f name=${containerName} -q | xargs --no-run-if-empty docker stop"
	sh "docker ps -a -f name=${containerName} -q | xargs -r docker rm"
	sh "docker run -d -p ${port}:5000 --name ${containerName}:${BUILD_NUMBER}"

}
